# hocuspocus-rs MVP chat summary (2025-10-28)

## Goals and scope
- Port Hocuspocus database persistence to Rust using yrs + axum.
- MVP: Database extension only; no auth; SQLite via sqlx; store full state blob (no increments).
- Server debounces persistence; extension remains stateless/idempotent.
- Reference learn-projects/* as read-only.

## Implemented

### Documentation and rules
- Added docs: architecture, mvp-scope, database extension spec, SQLite schema/usage, learn-projects summary.
- `.cursorrules` established repo rules and priorities.

### packages/extension-database
- `DatabaseExtension` trait with `fetch`/`store` contexts.
- `SqliteDatabase` adapter (sqlx SQLite): table `documents(name TEXT PK, state BLOB, updated_at INTEGER)`.
- Upsert and fetch queries; in-memory test passes.

### packages/server (axum)
- Minimal WS server with one route `/ws`.
- Document name derived from first frame (Hocuspocus envelope: varstring(documentName), varuint(MessageType), payload).
- Fetch/apply on first frame; then run y-sync/awareness handling.
- y-sync handler runs in a dedicated worker thread that owns `yrs::Doc` and `Awareness` to avoid Send constraints.
- Message handling:
  - Manual parse of y-sync submessages for robustness:
    - subtag 0 (SyncStep1): compute and send SyncStep2 (writeVarUint8Array(update)).
    - subtag 1/2 (SyncStep2/Update): decode v1/v2, apply update, send SyncStatus applied=1.
  - Awareness: echo updates back.
  - Ignored Auth for MVP.
- Debounce persistence in async WS task using latest full state emitted by worker on each doc update.
- Force-save behavior:
  - Track per-document connection counts and latest state (DashMap).
  - On last client leaving (count→0), immediately store latest state and clear caches.
  - Also flush pending store on close if debounce hasn’t fired yet.
- Extensive debug logs added (handshake, inbound/outbound frames, scheduling/storing, close paths).

### packages/extension-redis (optional)
- `RedisBroadcaster` using redis crate (Tokio):
  - publish_sync/publish_awareness(doc, framed_bytes)
  - subscribe(doc) => background task + mpsc channel; instance-id envelope to prevent echo loops.
- Server integration (feature `redis`):
  - On first frame and if redis configured, subscribe per doc; forward Redis frames into the worker.
  - When sending to client, also publish same framed bytes to Redis so other instances forward.
- `examples/basic.rs` wires Redis via env `REDIS_URL` and `INSTANCE_ID` (feature-gated).

## Known limitations / risks
- Protocol handling is manual; future updates in y-protocols could break assumptions. Consider replacing with a maintained yrs/y-sync codec (or align with yrs-axum patterns) when stabilizing.
- Awareness handling is minimal; may need periodic updates/heartbeats to match client expectations.
- No auth (by design for MVP); provider’s Auth frames are ignored.
- Persistence is full-state only; blobs can grow. Future: compression, periodic compaction, or snapshot + incremental log.
- No backpressure or flow control on Redis pub/sub paths.
- No multi-document server cache eviction policy besides last-client-unload; may need TTLs or memory ceilings.

## Testing status
- Unit tests pass for SQLite adapter.
- Server builds; local manual tests show y-sync handshake replies (SyncStep2), SyncStatus ack, awareness echo, and force-save on last-leave.
- Next: add e2e tests using a JS provider (or yrs-wasm client) and multi-instance Redis tests.

## Configuration
- `/ws` single route; doc name comes from first client frame.
- Debounce defaults: 250ms; maxDebounce: 2000ms (configurable in example).
- Redis (optional): set `REDIS_URL`, `INSTANCE_ID`; enable `--features redis`.

## Next steps (proposal)
1. Stabilize protocol handling
   - Replace manual parsing with a safe codec (y-sync crate or yrs-axum approach) while preserving Send safety.
   - Add awareness heartbeat/ping/pong alignment to reduce client disconnects.
2. Add e2e coverage
   - Provider-based test harness (Node/JS) and rs integration tests.
   - Multi-instance Redis propagation tests (edit on A, observe on B).
3. Config/Builder API
   - Public configuration builder for debounce, unloadImmediately, DB adapter, Redis options.
   - Surface unloadImmediately semantics like Hocuspocus.
4. Performance & resilience
   - Optional compression for state blobs; metrics/logging; backpressure for Redis.
5. Docs
   - Update docs/redis.md with wiring, env, instance-id guidance and operational notes.

## Open questions for planning
- yrs version: keep 0.24 (current) or align to yrs-axum version for protocol helpers?
- Persistence store options beyond SQLite for production (Postgres, S3 snapshots)?
- Auth story for non-MVP; token sync and scopes parity with Hocuspocus.
